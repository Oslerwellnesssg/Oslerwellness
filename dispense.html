<!doctype html>
<html><head><meta charset="utf-8"/><title>Osler Wellness — Dispense</title>
  <style>
    :root {
      --bg: #3b4d54; --card: #445a62; --text: #ffffff; --accent: #fe8d3f; --head: #3f5962; --border: #5e757d;
    }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:0; background: var(--bg); color: var(--text); line-height:1.45; }
    .container { padding: 20px; max-width: 1200px; margin: 0 auto; }
    .topbar { display:flex; gap:12px; align-items:center; margin-bottom:16px; }
    h2, h3 { margin: 0; font-weight: 650; }
    .btn { border:1px solid var(--border); padding:10px 14px; border-radius:10px; background: var(--accent); color: var(--text); cursor:pointer; }
    .btn.secondary { background: transparent; border-color: var(--accent); }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--border); font-size:12px; opacity:.9; }
    .card { border:1px solid var(--border); border-radius:14px; padding:16px; margin-bottom:16px; background: var(--card); }
    input, select { padding:10px; border-radius:10px; border:1px solid var(--border); background:#2b3b41; color: var(--text); outline:none; }
    label { font-size: 12px; opacity:.9; }
    .row { display:flex; gap:12px; flex-wrap: wrap; }
    .field { display:flex; flex-direction:column; gap:6px; min-width:180px; flex:1 1 180px; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SB_URL="https://zwocjuiqkmfgtenzjdcy.supabase.co";
    const SB_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3b2NqdWlxa21mZ3RlbnpqZGN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5Njk4MDEsImV4cCI6MjA3MjU0NTgwMX0.c4OyvfF3tfFM6uwaEcbUMh6WJJqythetshxThrMuAQg";
    let sb=null; function sbc(){ if(!sb) sb = supabase.createClient(SB_URL, SB_ANON); return sb; }

    function qp(n){ const p=new URLSearchParams(location.search); return p.get(n)||null; }
    function b64urlDecode(s){ try{ return atob(s.replace(/-/g,'+').replace(/_/g,'/')); }catch(e){ return null; } }
    function safeJwtDecode(t){ try{ const parts=String(t||'').split('.'); if(parts.length!==3) return null; const json=b64urlDecode(parts[1]); if(!json) return null; return JSON.parse(decodeURIComponent(escape(json))); }catch(e){ return null; } }
    function extractHexId(str){ const m=String(str||'').match(/[a-f0-9]{24,36}/i); return m?m[0]:null; }
    function resolvePid(){
      const direct = qp('patient') || qp('pid') || null;
      if(direct) return direct;
      const tk = qp('token'); if(!tk) return null;
      const pl = safeJwtDecode(tk);
      if(pl){
        const keys=['patient_id','platoId','PlatoID','id','patientId'];
        for(const k of keys){ if(pl[k]) return String(pl[k]); }
        if(pl.patient && (pl.patient.id||pl.patient.PlatoID)) return String(pl.patient.id||pl.patient.PlatoID);
        for(const [k,v] of Object.entries(pl)){ if(/id/i.test(k)&&(typeof v==='string'||typeof v==='number')) return String(v); }
      }
      const hex = extractHexId(tk); return hex || null;
    }

    const defaultRemarks='1 Tab per day'; const LOCS=['RH1','SV'];
    let PID=null, productCache=[], lineCount=0;

    async function productsList(){
      const { data } = await sbc().from('products_with_balances')
        .select('id,name,sku,on_hand_sv,on_hand_rh1').order('name');
      return data||[];
    }
    function productIdFromInput(val){ const m=/::\s*([0-9a-f-]{36})$/i.exec(val||''); return m?m[1]:null; }
    function productMetaById(id){ return (productCache||[]).find(p=>p.id===id) || null; }

    function lineTpl(idx, list){
      return `<div class="card" style="flex:1 1 100%"><div class="row">
        <div class="field" style="min-width:320px"><label>Product</label>
          <input list="pdl_${idx}" id="prod_${idx}" placeholder="Type to search by name or SKU"/>
          <datalist id="pdl_${idx}">${list.map(p=>`<option value="${p.name} [${p.sku||''}] :: ${p.id}"></option>`).join('')}</datalist></div>
        <div class="field"><label>Location</label><select id="loc_${idx}">${LOCS.map(l=>`<option value="${l}">${l}</option>`).join('')}</select></div>
        <div class="field"><label>Quantity</label><input id="qty_${idx}" type="number" min="1" step="1" value="1"/></div>
        <div class="field"><label>Doctor initials</label><input id="doc_${idx}" placeholder="e.g. LS"/></div>
        <div class="field" style="min-width:260px"><label>Dosage/Remarks</label><input id="rem_${idx}" value="${defaultRemarks}"/></div>
        <div class="field"><label>&nbsp;</label><button class="btn" style="background:#d45b5b" onclick="removeLine(${idx})">Remove</button></div>
      </div></div>`;
    }

    async function addLine(){ if(!productCache.length) productCache=await productsList();
      const c=document.getElementById('line-rows'); c.insertAdjacentHTML('beforeend', lineTpl(lineCount, productCache)); lineCount++; }
    function removeLine(i){ const e=document.getElementById('prod_'+i); const w=e?.closest('.card'); if(w) w.remove(); }

    async function submitAll(){
      if(!PID){ alert('No patient in context — open from Plato or pass token=…'); return; }
      const ops=[];
      for(let i=0;i<lineCount;i++){
        const p=document.getElementById('prod_'+i); if(!p) continue;
        const id=productIdFromInput(p.value); if(!id) return alert('Line '+(i+1)+': choose a product from the list.');
        const loc=document.getElementById('loc_'+i).value;
        const qty=parseInt(document.getElementById('qty_'+i).value||'0',10);
        const doc=document.getElementById('doc_'+i).value.trim();
        const rem=document.getElementById('rem_'+i).value.trim()||defaultRemarks;
        if(!qty||qty<1) return alert('Line '+(i+1)+': quantity must be >=1');
        const meta = productMetaById(id) || {};
        ops.push({id,loc,qty,doc,rem,name: meta.name||'', sku: meta.sku||''});
      }
      if(!ops.length) return alert('Add at least one item.');

      for (const op of ops) {
        const res = await sbc().rpc('post_sale_at', {
          p_product: op.id, p_loc: op.loc, p_qty: op.qty, p_price: 0,
          p_patient: PID, p_doctor: op.doc || null, p_remarks: op.rem || null
        });
        if (res.error) {
          const m = (res.error.message || '').toLowerCase();
          if (m.includes('insufficient stock')) {
            const ok = confirm(`Insufficient stock at ${op.loc}.\n\nCreate a PRE-ORDER instead (no stock change)?`);
            if (!ok) return alert('Cancelled.');
            const res2 = await sbc().rpc('place_preorder', {
              p_product: op.id, p_loc: op.loc, p_qty: op.qty,
              p_patient: PID, p_doctor: op.doc || null,
              p_remarks: (op.rem || '') + ' [PRE-ORDER]'
            });
            if (res2.error) return alert('Pre-order failed: ' + res2.error.message);
            try {
              await fetch('/.netlify/functions/notify-preorder', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  patientId: PID, productName: op.name || '', sku: op.sku || '',
                  qty: op.qty, location: op.loc, doctor: op.doc || '',
                  remarks: op.rem || '', createdAt: new Date().toISOString()
                })
              });
            } catch(e){ /* ignore */ }
            continue;
          }
          return alert('Error: ' + res.error.message);
        }
      }
      window.open('records.html'+location.search, '_blank');
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      PID = resolvePid();
      document.getElementById('pid').textContent='patient: '+(PID||'—');
      addLine();
    });
  </script>
</head>
<body>
<div class="container">
  <div class="topbar">
    <h2>Dispense</h2>
    <span id="pid" class="pill">patient: …</span>
    <div style="flex:1"></div>
    <button class="btn secondary" onclick="window.close()">Close</button>
  </div>
  <div class="card">
    <div class="row" id="line-rows"></div>
    <div style="margin-top:12px; display:flex; gap:12px;">
      <button class="btn secondary" onclick="addLine()">Add item</button>
      <button class="btn" onclick="submitAll()">Submit</button>
    </div>
  </div>
</div>
</body></html>
