<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Movement Report</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:#202a33; color:#e8eef3; margin:0; padding:24px;}
    .wrap{max-width:1100px; margin:0 auto;}
    h1{margin:0 0 4px 0;}
    .muted{opacity:.8}
    h2{margin-top:24px;}
    table{width:100%; border-collapse:collapse; margin-top:8px;}
    th,td{padding:10px; border-bottom:1px solid #2b3742; text-align:left;}
    th{background:#253341; position:sticky; top:0;}
    tr:nth-child(even){background:#1c2732;}
    .toolbar{display:flex; gap:8px; align-items:center; margin:12px 0 16px;}
    button{background:#2e7d89; border:0; color:white; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <button id="btnRefresh">Refresh</button>
    </div>
    <h1>Movement Report</h1>
    <div class="muted">Shows recent <strong>dispense</strong> and <strong>preorder</strong> activity.</div>

    <h2>Star Vista (SV)</h2>
    <table id="tblSV"><thead>
      <tr><th>Date/Time</th><th>Patient</th><th>Product</th><th>Qty</th><th>Price</th><th>Total</th><th>Status</th></tr>
    </thead><tbody></tbody></table>

    <h2>Raffles (RH1)</h2>
    <table id="tblRH1"><thead>
      <tr><th>Date/Time</th><th>Patient</th><th>Product</th><th>Qty</th><th>Price</th><th>Total</th><th>Status</th></tr>
    </thead><tbody></tbody></table>
  </div>
<script>
const params = new URLSearchParams(location.search);
const API_URL = params.get('api') || (window.SUPABASE_URL || '');
const TOKEN   = params.get('token');

if (!TOKEN || !API_URL) {
  console.warn('Missing token or api url. Provide ?api=<supabase-url>&token=<anon-or-service-role>');
}

async function sb(path) {
  const res = await fetch(`${API_URL}${path}`, {
    headers: { 'apikey': TOKEN, 'Authorization': `Bearer ${TOKEN}` }
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

function rowHTML(r) {
  const dt = new Date(r.created_at).toLocaleString();
  const total = r.line_total != null ? Number(r.line_total).toFixed(2) : '';
  const price = r.unit_price != null ? Number(r.unit_price).toFixed(2) : '';
  const status = r.type === 'preorder' ? 'PRE-ORDER' : 'OK';
  return `<tr><td>${dt}</td><td>${r.patient_id||''}</td><td>${r.product_name}</td><td>${r.qty_out||0}</td><td>${price}</td><td>${total}</td><td>${status}</td></tr>`;
}

async function load() {
  // Pull from movements_with_products and split by from_loc (SV/RH1)
  const rows = await sb('/rest/v1/movements_with_products?select=*&order=created_at.desc&limit=200');
  const sv = rows.filter(r => r.from_loc === 'SV');
  const rh1 = rows.filter(r => r.from_loc === 'RH1');

  const tsv = document.querySelector('#tblSV tbody');
  tsv.innerHTML = sv.map(rowHTML).join('');
  const trh1 = document.querySelector('#tblRH1 tbody');
  trh1.innerHTML = rh1.map(rowHTML).join('');
}

document.getElementById('btnRefresh').addEventListener('click', load);
load();
</script>
</body>
</html>