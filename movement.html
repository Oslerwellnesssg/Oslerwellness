
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movement report</title>
  <style>
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;background:#0d1b24;color:#e6eef2;margin:0}
    .wrap{max-width:1080px;margin:32px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 12px}
    .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    a.btn,button{background:#204051;color:#fff;border:0;border-radius:8px;padding:10px 14px;font-weight:600;cursor:pointer;text-decoration:none;display:inline-block}
    .note{background:#122631;color:#bdd7e3;padding:10px 12px;border-radius:8px;font-size:12px;opacity:.9;margin-bottom:12px}
    table{width:100%;border-collapse:collapse;background:#122631;border-radius:12px;overflow:hidden;margin-bottom:28px}
    th,td{padding:12px 10px;border-bottom:1px solid #223a48}
    th{background:#163242;text-align:left;font-size:12px;letter-spacing:.02em;text-transform:uppercase;color:#9fc1d3}
    tr:hover td{background:#152a36}
    .right{text-align:right}
    h2{font-size:16px;margin:18px 0 8px;color:#9fc1d3}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <a class="btn" href="inventory.html">‚Üê Back to inventory</a>
      <h1>Movement report</h1>
      <span></span>
    </div>

    <div class="note">Shows dispenses (and pre-orders) grouped by location. Patient IDs link back to Plato.</div>

    <h2>Raffles (RH1)</h2>
    <table id="rh1"><thead><tr>
      <th>Date/Time</th><th>Patient ID</th><th>Product</th><th class="right">Qty</th><th class="right">Price</th><th>Status</th>
    </tr></thead><tbody></tbody></table>

    <h2>Star Vista (SV)</h2>
    <table id="sv"><thead><tr>
      <th>Date/Time</th><th>Patient ID</th><th>Product</th><th class="right">Qty</th><th class="right">Price</th><th>Status</th>
    </tr></thead><tbody></tbody></table>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const SB_URL = qs.get('sbUrl') || '%%SUPABASE_URL%%';
  const SB_ANON = qs.get('sbAnon') || '%%SUPABASE_ANON%%';
  const PLATO_BASE = "https://clinic.platomedical.com/#/patients/"; // adjust if needed

  function addRow(tbody, r){
    const tr = document.createElement("tr");
    const patientLink = r.patient_id ? `<a target="_blank" href="${PLATO_BASE}${encodeURIComponent(r.patient_id)}/details">${r.patient_id}</a>` : "";
    tr.innerHTML = `<td>${new Date(r.ts).toLocaleString()}</td>
      <td>${patientLink}</td>
      <td>${r.product||""}</td>
      <td class="right">${r.qty??""}</td>
      <td class="right">${(r.price!=null)?Number(r.price).toFixed(2):""}</td>
      <td>${r.status||""}</td>`;
    tbody.appendChild(tr);
  }

  async function load() {
    const url = SB_URL.replace(/\/$/,'') + "/rest/v1/recent_movements_for_ui?select=ts,patient_id,product,qty,price,location,status&order=ts.desc";
    const res = await fetch(url, { headers: { apikey: SB_ANON, Authorization: "Bearer "+SB_ANON }});
    if(!res.ok){ alert("Failed to load movement view: " + res.status + " " + (await res.text())); return; }
    const rows = await res.json();
    const rh1 = document.querySelector("#rh1 tbody");
    const sv  = document.querySelector("#sv tbody");
    rh1.innerHTML = sv.innerHTML = "";
    for(const r of rows){
      if((r.location||"").toUpperCase()==="RH1") addRow(rh1, r);
      else addRow(sv, r);
    }
  }

  if(!SB_URL || SB_URL.startsWith("%%")) {
    console.warn("Supabase URL/anon not provided. Pass ?sbUrl=...&sbAnon=... or edit the placeholders.");
  }
  load();
})();
</script>
</body>
</html>
