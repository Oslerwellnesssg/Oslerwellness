<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Movement report</title>
  <link rel="preconnect" href="https://esm.sh"/>
  <style>
    body { background:#111a22; color:#e7edf3; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .wrap { max-width:1040px; margin:24px auto; padding:0 16px; }
    h1 { font-size:22px; margin:16px 0; display:flex; align-items:center; gap:12px; }
    .row { display:flex; gap:12px; align-items:center; }
    button { background:#1985ff; color:white; border:0; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:600; }
    button.link { background:transparent; border:1px solid #2b4252; }
    .bar { background:#0f2532; border-radius:10px; padding:10px 14px; margin:12px 0 16px; color:#87a2b3; font-size:13px; }
    h2 { margin-top:22px; font-size:16px; color:#9fb6c6; }
    table { width:100%; border-collapse:collapse; background:#0e1d27; border-radius:12px; overflow:hidden; }
    th, td { padding:12px 14px; border-bottom:1px solid #142e3c; font-size:14px; }
    th { text-align:left; color:#9fb6c6; background:#0f2130; position:sticky; top:0; }
    tr:hover td { background:#132636; }
    .right { text-align:right; }
    a { color:#8ecbff; text-decoration:none; }
  </style>
  <script>
    window.DEFAULT_SUPABASE_URL  = "";
    window.DEFAULT_SUPABASE_ANON = "";
  </script>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <button class="link" id="backBtn">← Back to inventory</button>
      <h1>Movement report</h1>
    </div>
    <div class="bar">Shows dispenses (and pre‑orders) grouped by location. Patient IDs link back to Plato.</div>

    <h2>Raffles (RH1)</h2>
    <table id="tblRH1">
      <thead>
        <tr><th>Date/Time</th><th>Patient ID</th><th>Product</th><th class="right">Qty</th><th class="right">Price</th><th>Status</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>Star Vista (SV)</h2>
    <table id="tblSV">
      <thead>
        <tr><th>Date/Time</th><th>Patient ID</th><th>Product</th><th class="right">Qty</th><th class="right">Price</th><th>Status</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2.45.4";
  const urlParams = new URLSearchParams(window.location.search);
  const SB_URL  = urlParams.get("sbUrl")  || window.DEFAULT_SUPABASE_URL || "";
  const SB_ANON = urlParams.get("sbAnon") || window.DEFAULT_SUPABASE_ANON || "";
  if (!SB_URL || !SB_ANON) {
    console.error("Missing sbUrl or sbAnon. Provide them via query string or set DEFAULT_SUPABASE_* in the page.");
    document.getElementById("err").textContent = "Missing Supabase credentials. Add sbUrl & sbAnon to the URL.";
  }
  const supabase = createClient(SB_URL, SB_ANON);

  // Expose supabase to other inline scripts on the page
  window.supabase = supabase;
</script>


  <script type="module">
    function platoLink(patientId) {
      if (!patientId) return "";
      return `https://clinic.platomedical.com/#/patients/${patientId}/details`;
    }

    function rowHtml(r) {
      const when = new Date(r.ts).toLocaleString();
      const pid = r.patient_id ? `<a href="${platoLink(r.patient_id)}" target="_blank">${r.patient_id}</a>` : "";
      return `<tr>
        <td>${when}</td>
        <td>${pid}</td>
        <td>${r.product ?? ""}</td>
        <td class="right">${r.qty ?? 0}</td>
        <td class="right">${Number(r.price ?? 0).toFixed(2)}</td>
        <td>${r.status ?? ""}</td>
      </tr>`;
    }

    async function load() {
      const { data, error } = await window.supabase
        .from("recent_movements_for_ui")
        .select("*")
        .order("ts", { ascending:false })
        .limit(500);
      if (error) {
        console.error(error);
        return;
      }
      const rh1 = data.filter(r => r.location === "RH1");
      const sv  = data.filter(r => r.location === "SV");

      document.querySelector("#tblRH1 tbody").innerHTML = rh1.map(rowHtml).join("") || "<tr><td colspan='6' style='color:#7ea2b8'>No rows</td></tr>";
      document.querySelector("#tblSV tbody").innerHTML  = sv.map(rowHtml).join("")  || "<tr><td colspan='6' style='color:#7ea2b8'>No rows</td></tr>";
    }

    document.getElementById("backBtn").addEventListener("click", () => {
      const qs = window.location.search;
      window.location.href = "inventory.html" + qs;
    });

    load();
  </script>
</body>
</html>
