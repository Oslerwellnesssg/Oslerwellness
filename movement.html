<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movement report</title>
  <style>
    :root { color-scheme: dark; }
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;background:#0f172a;margin:0;color:#e5e7eb}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .row{display:flex;align-items:center;gap:12px}
    h1{margin:0;font-size:22px;font-weight:700}
    a.btn{background:#0ea5e9;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;text-decoration:none}
    .pill{background:#0b1220;border:1px solid #233; border-radius:10px;padding:10px 12px;margin:16px 0;font-size:13px;color:#9ca3af}
    h2{font-size:16px;margin:24px 0 8px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{text-align:left;padding:10px 12px;background:#111827}
    th{font-size:12px;color:#9ca3af;font-weight:600}
    tr td:first-child, tr th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tr td:last-child, tr th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .muted{color:#9ca3af}
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <a class="btn" id="backBtn" href="#">← Back to inventory</a>
      <h1>Movement report</h1>
    </div>
    <div class="pill">Shows dispenses (and pre-orders) grouped by location. Patient IDs link back to Plato.</div>

    <h2>Raffles (RH1)</h2>
    <table>
      <thead>
        <tr><th>Date/Time</th><th>Patient ID</th><th>Product</th><th>Qty</th><th>Price</th><th>Status</th></tr>
      </thead>
      <tbody id="tbody-rh1"></tbody>
    </table>

    <h2>Star Vista (SV)</h2>
    <table>
      <thead>
        <tr><th>Date/Time</th><th>Patient ID</th><th>Product</th><th>Qty</th><th>Price</th><th>Status</th></tr>
      </thead>
      <tbody id="tbody-sv"></tbody>
    </table>

    <p class="muted" id="footNote"></p>
  </div>

<script>
const SB_URL  = window.__SB_URL  || "YOUR_SUPABASE_URL";
const SB_ANON = window.__SB_ANON || "YOUR_SUPABASE_ANON_KEY";
const supa = supabase.createClient(SB_URL, SB_ANON);

function getTokenQS(){
  const u = new URL(window.location.href);
  const t = u.searchParams.get("token");
  return t ? ("?token=" + encodeURIComponent(t)) : "";
}
document.getElementById("backBtn").href = "inventory.html" + getTokenQS();

function platoPatientUrl(pid){
  // Plato patient route patterns vary; keep it simple: open Plato and let staff search by ID
  // If you have a direct route, put it here instead.
  return "https://clinic.platomedical.com/#/patients?search=" + encodeURIComponent(pid||"");
}

function renderRows(el, rows){
  el.innerHTML = "";
  rows.forEach(r=>{
    const tr = document.createElement("tr");
    const status = (r.type==="preorder") ? "PRE-ORDER" : "OK";
    tr.innerHTML = `
      <td>${new Date(r.created_at).toLocaleString()}</td>
      <td>${r.patient_id ? `<a href="${platoPatientUrl(r.patient_id)}" target="_blank">${r.patient_id}</a>` : ""}</td>
      <td>${r.product_name||""}</td>
      <td>${r.qty_out||r.qty_in||0}</td>
      <td>${(r.unit_price!=null)? Number(r.unit_price).toFixed(2) : ""}</td>
      <td>${status}</td>
    `;
    el.appendChild(tr);
  });
}

async function load(){
  document.getElementById("footNote").textContent = "Loading…";
  try{
    // try movements_with_products (exists in your SQL)
    const { data, error } = await supa
      .from("movements_with_products")
      .select("created_at,type,product_name,from_loc,to_loc,qty_in,qty_out,patient_id,unit_price")
      .order("created_at", { ascending:false })
      .limit(500);
    if(error) throw error;
    const rh1 = data.filter(r => (r.from_loc==="RH1" || r.to_loc==="RH1") && (r.type==="dispense" || r.type==="preorder"));
    const sv  = data.filter(r => (r.from_loc==="SV"  || r.to_loc==="SV" ) && (r.type==="dispense" || r.type==="preorder"));
    renderRows(document.getElementById("tbody-rh1"), rh1);
    renderRows(document.getElementById("tbody-sv"), sv);
    document.getElementById("footNote").textContent = "Loaded from movements_with_products.";
  }catch(e){
    document.getElementById("footNote").textContent = "Failed to load: " + e.message;
  }
}
load();
</script>
</body>
</html>
