<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movement report</title>
  <style>
    body{background:#1f2a33;color:#e6edf3;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;}
    .wrap{max-width:980px;margin:28px auto;padding:0 16px;}
    .card{background:#2b3943;border-radius:12px;padding:16px 18px;margin:12px 0;box-shadow:0 2px 12px rgba(0,0,0,.35);}
    h1{font-size:28px;margin:6px 0 12px 0;}
    .muted{opacity:.75;font-size:13px;margin-bottom:10px}
    .row{display:flex;gap:16px;align-items:flex-start}
    .col{flex:1}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);font-size:14px}
    th{color:#9fb7c8;font-weight:600;text-align:left}
    .btn{background:#334a56;border:1px solid rgba(255,255,255,.15);color:#dbe9f3;padding:8px 12px;border-radius:9px;cursor:pointer;text-decoration:none;display:inline-block}
    .btn:hover{filter:brightness(1.08)}
    .right{float:right}
    .pill{border-radius:999px;padding:8px 14px}
    .status{padding:3px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.2);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;align-items:center;gap:10px;justify-content:space-between">
      <h1>Movement report</h1>
      <a class="btn pill right" id="backBtn" href="#">‚Üê Back to inventory</a>
    </div>

    <div class="card muted">Shows dispenses (and pre-orders) grouped by location. Patient IDs link back to Plato.</div>

    <div class="row">
      <div class="col card">
        <h3>Raffles (RH1)</h3>
        <table id="tblRH1">
          <thead>
            <tr><th>Date/Time</th><th>Patient ID</th><th>Product</th><th>Qty</th><th>Price</th><th>Status</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="col card">
        <h3>Star Vista (SV)</h3>
        <table id="tblSV">
          <thead>
            <tr><th>Date/Time</th><th>Patient ID</th><th>Product</th><th>Qty</th><th>Price</th><th>Status</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
// --- helpers from inventory.html ---
function getQueryParam(name){ const p=new URLSearchParams(window.location.search); return p.get(name)||null; }
function safeJwtDecode(token){
  try{ const parts=token.split('.'); if(parts.length!==3) return null;
       const json=atob(parts[1].replace(/-/g,'+').replace(/_/g,'/'));
       return JSON.parse(decodeURIComponent(escape(json))); }catch(e){ return null; } }

function supaClientFromToken(){
  const token = getQueryParam('token');
  if(!token){ alert('Missing token'); throw new Error('no token'); }
  const payload = safeJwtDecode(token);
  if(!payload){ alert('Bad token'); throw new Error('bad token'); }
  const { SUPABASE_URL, SUPABASE_KEY } = payload;
  if(!SUPABASE_URL || !SUPABASE_KEY){ alert('Token missing Supabase keys'); throw new Error('bad token'); }
  // lightweight fetch wrapper
  async function q(sql){
    const url = `${SUPABASE_URL}/rest/v1/rpc/exec_sql`;
    const r = await fetch(url, { method:'POST',
      headers:{ 'apikey':SUPABASE_KEY, 'Authorization':`Bearer ${SUPABASE_KEY}`, 'Content-Type':'application/json' },
      body: JSON.stringify({ q: sql })
    });
    if(!r.ok) throw new Error('Supabase RPC failed '+r.status);
    return r.json();
  }
  async function sel(table, opts){
    const url = new URL(`${SUPABASE_URL}/rest/v1/${table}`);
    url.searchParams.set('select', opts?.select || '*');
    if(opts?.order) url.searchParams.set('order', opts.order);
    const r = await fetch(url, { headers:{ 'apikey':SUPABASE_KEY, 'Authorization':`Bearer ${SUPABASE_KEY}` } });
    if(!r.ok) throw new Error('select failed: '+r.status);
    return r.json();
  }
  return { q, sel, SUPABASE_URL, SUPABASE_KEY, payload };
}

function platolink(patient_id){
  // If patient_id looks like a Plato UUID, link to the patient in Plato.
  return `https://clinic.platomedical.com/#/patients/${encodeURIComponent(patient_id)}/details`;
}

// --- renderers ---
function tr(cells){
  const tr = document.createElement('tr');
  cells.forEach(c=>{ const td=document.createElement('td'); td.innerHTML=c; tr.appendChild(td); });
  return tr;
}

(async function init(){
  // Back link keeps token
  const token = getQueryParam('token');
  const back = document.getElementById('backBtn');
  const inv = new URL('inventory.html', window.location.href);
  if(token) inv.searchParams.set('token', token);
  back.href = inv.toString();

  const supa = supaClientFromToken();

  // Try views in order until one exists/returns data
  const candidates = [
    { table:'v_ow_movement_report', select:'*', order:'ts.desc' },
    { table:'recent_movements_for_ui', select:'*', order:'ts.desc' },
    { table:'recent_movements', select:'*', order:'created_at.desc' },
    { table:'movements_with_products', select:'*', order:'created_at.desc' },
    { table:'movements_view', select:'*', order:'created_at.desc' },
  ];

  let rows = [];
  for(const c of candidates){
    try{
      rows = await supa.sel(c.table, { select:c.select, order:c.order });
      if(Array.isArray(rows) && rows.length>=0){ console.log('using', c.table); break; }
    }catch(e){ /* try next */ }
  }

  const tbodySV = document.querySelector('#tblSV tbody');
  const tbodyRH1 = document.querySelector('#tblRH1 tbody');

  if(!rows.length){
    tbodySV.appendChild(tr(['No movements', '', '', '', '', '']));
    tbodyRH1.appendChild(tr(['No movements', '', '', '', '', '']));
    return;
  }

  // Normalise column names
  function col(r, names){ for(const n of names){ if(r[n]!==undefined && r[n]!==null) return r[n]; } return null; }

  rows.forEach(r=>{
    const ts = new Date(col(r, ['ts','created_at','occurred_at','date'])).toLocaleString();
    const loc = String(col(r, ['loc','location','loc_code','from_loc','to_loc','site','clinic','branch'])||'').toUpperCase();
    const pid = col(r, ['patient_id','patient','patient_uuid','patientid']) || '';
    const product = col(r, ['product','name','product_name']) || '';
    const qty = col(r, ['qty','quantity']) ?? '';
    const price = col(r, ['price','sell_price','unit_price']) ?? '';
    const status = col(r, ['status']) || '';

    const link = pid ? `<a class="btn" href="${platolink(pid)}" target="_blank" rel="noopener">${pid}</a>` : '';

    const rowEl = tr([ts, link, product, qty, price, `<span class="status">${status}</span>`]);
    if(loc === 'SV' || loc === 'STAR VISTA'){
      tbodySV.appendChild(rowEl);
    } else if(loc === 'RH1' || loc === 'RAFFLES'){
      tbodyRH1.appendChild(rowEl);
    } else {
      // if unknown, put on SV side to avoid dropping
      tbodySV.appendChild(rowEl);
    }
  });
})();
</script>
</body>
</html>
