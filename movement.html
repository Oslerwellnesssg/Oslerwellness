<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Movement report — Osler Wellness</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{--bg:#1f2b33;--card:#273842;--text:#eaf3f6;--muted:#b0c3ca;--accent:#ff8a3d;--line:#36515e}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    h1{margin:0;font-size:22px}
    .btn{border:1px solid var(--line);background:#2b3f49;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#111}
    .hint{border:1px solid var(--line);background:#22333c;padding:10px 12px;border-radius:12px;color:var(--muted);font-size:13px;margin-bottom:14px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .card{border:1px solid var(--line);background:var(--card);border-radius:14px;overflow:hidden}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-size:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);font-size:14px}
    th{color:var(--muted);text-align:left}
    td a{color:var(--accent);text-decoration:none}
    .empty{padding:14px;color:var(--muted)}
    @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <h1>Movement report</h1>
      <div>
        <button class="btn" id="backBtn">← Back to inventory</button>
      </div>
    </div>
    <div class="hint">Shows dispenses (and pre-orders) grouped by location. Patient IDs link back to Plato.</div>

    <div class="grid">
      <div class="card">
        <h2>Raffles (RH1)</h2>
        <table id="tbl-rh1">
          <thead>
            <tr><th>Date/Time</th><th>Patient ID</th><th>Product</th><th>Qty</th><th>Price</th><th>Status</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="empty" id="empty-rh1" hidden>No movements yet.</div>
      </div>
      <div class="card">
        <h2>Star Vista (SV)</h2>
        <table id="tbl-sv">
          <thead>
            <tr><th>Date/Time</th><th>Patient ID</th><th>Product</th><th>Qty</th><th>Price</th><th>Status</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="empty" id="empty-sv" hidden>No movements yet.</div>
      </div>
    </div>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const token = qs.get('token') || '';
  const SUPABASE_URL = (window.OW_SUPABASE_URL) || (qs.get('supabase_url') || '').trim();
  // Fallback: infer from your production URL if not passed (kept for compatibility)
  const urlGuess = SUPABASE_URL || (window.location.origin.includes('oslerwellness') ? 'https://gqvxmzvuzwffokjqhshl.supabase.co' : '');

  const client = supabase.createClient(urlGuess, token, { auth: { persistSession:false, detectSessionInUrl:false } });

  document.getElementById('backBtn').onclick = () => {
    const u = new URL('inventory.html', location.origin);
    if (token) u.searchParams.set('token', token);
    if (SUPABASE_URL) u.searchParams.set('supabase_url', SUPABASE_URL);
    location.href = u.toString();
  };

  const candidateViews = [
    'recent_movements_for_ui',
    'movements_with_products',
    'movements_view'
  ];

  function pick(colset, names){
    for (const n of names) if (n in colset) return n;
    return null;
  }

  function platoLinkFromPatientId(pid){
    if(!pid) return '';
    try {
      // Plato expects a plain patient id in the URL hash; using current host frame.
      return '#/patients/'+encodeURIComponent(pid)+'/details';
    } catch(e){ return ''; }
  }

  async function load(){
    let used = null, rows = [];
    for (const view of candidateViews){
      const { data, error } = await client.from(view).select('*').order('ts', { ascending:false }).limit(500);
      if (!error && Array.isArray(data)) { used = view; rows = data; break; }
    }
    if (!used){
      console.error('No movement view found:', candidateViews);
      return;
    }
    // Build a dynamic column map from the first row:
    const colset = rows[0] ? Object.fromEntries(Object.keys(rows[0]).map(k=>[k,true])) : {};
    const colTs = pick(colset, ['ts','created_at','occurred_at','inserted_at','date','datetime']);
    const colPid = pick(colset, ['patient_id','patient','pid']);
    const colName = pick(colset, ['name','product','product_name']);
    const colSku = pick(colset, ['sku']);
    const colQty = pick(colset, ['qty','quantity','qty_change']);
    const colPrice = pick(colset, ['price','sell_price','unit_price']);
    const colLoc = pick(colset, ['loc','location','loc_code','site']);
    const colStatus = pick(colset, ['status','state']);

    const rh1Body = document.querySelector('#tbl-rh1 tbody');
    const svBody  = document.querySelector('#tbl-sv tbody');

    function fmtTs(v){
      try{ return new Date(v).toLocaleString(); }catch(e){ return v ?? ''; }
    }
    function td(t){ const d = document.createElement('td'); d.textContent = t ?? ''; return d; }

    let rh1Count=0, svCount=0;
    for (const r of rows){
      const loc = (r[colLoc] || '').toString().toUpperCase();
      const tr = document.createElement('tr');
      const pid = r[colPid];
      // Patient link (opens inside Plato frame)
      const a = document.createElement('a');
      a.href = platoLinkFromPatientId(pid) || '#';
      a.textContent = pid ?? '';
      a.onclick = (ev)=>{ if(a.href==='#') ev.preventDefault(); };
      const pidTd = document.createElement('td'); pidTd.appendChild(a);

      tr.appendChild(td(fmtTs(r[colTs])));
      tr.appendChild(pidTd);
      tr.appendChild(td(r[colName] || r[colSku] || ''));
      tr.appendChild(td(r[colQty]));
      tr.appendChild(td(r[colPrice]));
      tr.appendChild(td(r[colStatus]));

      if (loc === 'RH1'){
        rh1Body.appendChild(tr); rh1Count++;
      } else if (loc === 'SV' || loc === 'STAR VISTA'){
        svBody.appendChild(tr); svCount++;
      }
    }
    document.getElementById('empty-rh1').hidden = rh1Count>0;
    document.getElementById('empty-sv').hidden = svCount>0;
  }

  load();
})();
</script>
</body>
</html>