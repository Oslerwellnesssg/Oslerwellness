<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Inventory (Live from Supabase)</title>
<style>
  :root{--bg:#0f1a21;--card:#15252e;--text:#dfe8ee;--muted:#8aa0ad;--accent:#ff8a3d;--pill:#223946;--pillTxt:#bfe3ff}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1080px;margin:28px auto;padding:0 16px}
  h1{margin:0 0 10px 0;font-size:28px;font-weight:700}
  .sub{margin:0 0 16px 0;color:var(--muted)}
  .actions{display:flex;gap:10px;margin:8px 0 16px 0;justify-content:flex-end}
  button{background:var(--accent);border:none;color:#111;padding:8px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn-secondary{background:var(--pill);color:var(--pillTxt)}
  .panel{background:var(--card);padding:12px;border-radius:14px;box-shadow:0 0 0 1px rgba(255,255,255,.03) inset}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  thead th{color:var(--muted);text-align:left;font-weight:600;padding:0 12px}
  tbody tr{background:#12222a}
  td{padding:12px}
  .right{text-align:right}
  .muted{color:var(--muted)}
  .pill{background:var(--pill);color:var(--pillTxt);padding:2px 8px;border-radius:999px;font-size:12px}
</style>
<script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
const SUPABASE_URL = "https://zwocjuiqkmfgtenzjdcy.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3b2NqdWlxa21mZ3RlbnpqZGN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5Njk4MDEsImV4cCI6MjA3MjU0NTgwMX0.c4OyvfF3tfFM6uwaEcbUMh6WJJqythetshxThrMuAQg";
const qs = new URLSearchParams(location.search);
const urlOverride = qs.get('supabase_url');
const keyOverride = qs.get('supabase_anon_key');
const sb = window.supabase.createClient(urlOverride || SUPABASE_URL, keyOverride || SUPABASE_ANON_KEY);

async function firstSource(sources, select) {
  for (const src of sources) {
    try {
      const { data: rows, error: err } = await sb.from(src).select(select).limit(1);
      if (!err) return src;
    } catch(e){}
  }
  throw new Error("No suitable source found");
}

function money(v) {
  if (v == null || v === '') return '0.00';
  const n = Number(v);
  return isFinite(n) ? n.toFixed(2) : String(v);
}

function get(obj, keys, def=null) {
  for (const k of keys) {
    if (obj && Object.prototype.hasOwnProperty.call(obj, k) && obj[k] != null) return obj[k];
  }
  return def;
}
</script>
</head>

<body>
<div class="wrap">
  <h1>Inventory <span class="muted">Live from Supabase</span></h1>
  <p class="sub">How this updates: Shopify Flow → Netlify Function → Supabase. Click <b>Sync now</b> to force-refresh (optional).</p>
  <div class="actions">
    <button class="btn-secondary" id="btnRefresh">Refresh</button>
    <button class="btn-secondary" id="btnSync">Sync now</button>
    <a href="./movement.html" class="btn-secondary" id="btnMovement" style="text-decoration:none;display:inline-block;padding:8px 14px;border-radius:10px">Movement report</a>
  </div>

  <div class="panel">
    <table>
      <thead>
        <tr><th>Name</th><th>SKU</th><th>Barcode</th><th class="right">Unit $</th><th class="right">SV</th><th class="right">RH1</th><th class="right">Total</th></tr>
      </thead>
      <tbody id="rows"><tr><td class="muted">Loading…</td></tr></tbody>
    </table>
  </div>
</div>

<script>
const SYNC_URL = new URLSearchParams(location.search).get('sync_url') || null;

async function loadInventory() {
  const candidates = ["v_stock_totals","products_with_balances","products_for_ui"];
  const src = await firstSource(candidates, "*");
  const { data, error } = await sb.from(src).select("*").order('name', { ascending: true });
  const body = document.getElementById('rows');
  if (error) { body.innerHTML = `<tr><td class='muted'>Error: ${error.message}</td></tr>`; return; }
  if (!data || data.length === 0) { body.innerHTML = "<tr><td class='muted'>No rows.</td></tr>"; return; }
  body.innerHTML = "";
  for (const r of data) {
    const name = get(r, ["name","title","product"], "");
    const sku = get(r, ["sku"], "");
    const barcode = get(r, ["barcode","bar_code"], "");
    const price = get(r, ["sell_price","price"], 0);
    const sv = Number(get(r, ["sv","SV","sv_qty"], 0)) || 0;
    const rh1 = Number(get(r, ["rh1","RH1","rh_qty"], 0)) || 0;
    const total = get(r, ["total"], (sv+rh1));
    body.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${name}</td>
        <td>${sku}</td>
        <td>${barcode}</td>
        <td class="right">${money(price)}</td>
        <td class="right">${sv}</td>
        <td class="right">${rh1}</td>
        <td class="right">${total}</td>
      </tr>`);
  }
}

document.getElementById('btnRefresh').onclick = loadInventory;
document.getElementById('btnSync').onclick = async () => {
  if (!SYNC_URL) { alert("No sync_url provided. Append ?sync_url=https://YOUR_FUNCTION_URL to this page if you want Sync now to call it."); return; }
  try {
    const res = await fetch(SYNC_URL, { method: 'POST' });
    if (!res.ok) throw new Error("Sync failed");
    alert("Sync request sent. Refresh after a few seconds.");
  } catch(e) { alert(e.message); }
};

loadInventory();
</script>
</body>
</html>
