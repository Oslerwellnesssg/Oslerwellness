<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventory (Live from Shopify)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#1f2937; --panel:#263241; --text:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee;
  }
  * { box-sizing:border-box; }
  body { margin:0; background:var(--bg); color:var(--text); font-family:Inter,system-ui,Arial; }
  .shell{ max-width:1100px; margin:30px auto; padding:0 16px; }
  .bar{ display:flex; align-items:center; gap:12px; }
  h1{ margin:0; font-size:24px; }
  .btn{ background:#0ea5b7; color:#062b30; font-weight:600; padding:8px 12px; border-radius:8px; cursor:pointer; border:none; }
  .btn.secondary{ background:#334155; color:#cbd5e1; }
  .card{ background:var(--panel); border:1px solid #334155; border-radius:12px; margin-top:16px; overflow:hidden; }
  table{ width:100%; border-collapse:collapse; }
  th,td{ padding:12px 14px; border-bottom:1px solid #344255; font-size:14px; }
  th{ background:#2b3a4d; text-align:left; color:#cbd5e1; }
  .hint{ font-size:13px; color:var(--muted); background:#223042; border:1px solid #344255; padding:10px 14px; border-radius:10px; margin-top:14px; }
  .right{ margin-left:auto; }
  a.link{ color:var(--accent); text-decoration:none; }
</style>
<script>

async function loadJSON(url, opts={}){
  const res = await fetch(url, opts);
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}

function getParam(name){
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}

function supaHeaders(token){
  const h = { "Content-Type":"application/json" };
  if(token) h["Authorization"] = `Bearer ${token}`;
  return h;
}

let SUPA_URL, TOKEN;

async function fetchInventory(){
  const url = new URL(SUPA_URL + "/rest/v1/rpc");
  url.pathname += "/";
  // Query the view products_with_balances directly
  const q = new URL(SUPA_URL + "/rest/v1/products_with_balances");
  q.searchParams.set("select", "*");
  q.searchParams.set("order", "name");
  const rows = await loadJSON(q.toString(), { headers: supaHeaders(TOKEN) });
  return rows;
}

function render(rows){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";
  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.name||""}</td>
      <td>${r.sku||""}</td>
      <td>${r.barcode||""}</td>
      <td>${Number(r.sell_price||0).toFixed(2)}</td>
      <td>${r.on_hand_sv||0}</td>
      <td>${r.on_hand_rh1||0}</td>
      <td>${r.on_hand_total||0}</td>`;
    tbody.appendChild(tr);
  }
}

async function syncNow(){
  try{
    const res = await fetch("/.netlify/functions/shopify-sync-now");
    const txt = await res.text();
    alert("Sync complete");
    await boot(); // reload data
  }catch(e){
    alert("Sync failed: "+ e.message);
  }
}

async function boot(){
  SUPA_URL = getParam("url") || window.SUPABASE_URL;
  TOKEN    = getParam("token") || window.SUPABASE_KEY;
  const rows = await fetchInventory();
  render(rows);
}
</script>
</head>
<body onload="boot()">
  <div class="shell">
    <div class="bar">
      <button class="btn" onclick="syncNow()">Sync now</button>
      <h1>Inventory (Live from Shopify)</h1>
      <div class="right">
        <a class="btn secondary" href="movement.html{location.search}">Movement report</a>
      </div>
    </div>

    <div class="hint">
      <strong>How this updates:</strong> Live updates arrive via Shopify Flow → Netlify Function → Supabase. 
      This page reads from Supabase. Click <em>Sync now</em> to force-refresh.
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Product</th><th>SKU</th><th>Barcode</th><th>Price</th><th>SV</th><th>RH1</th><th>Total</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</body>
</html>
