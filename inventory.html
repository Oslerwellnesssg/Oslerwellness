<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Inventory (Live from Shopify)</title>
  <link rel="preconnect" href="https://esm.sh"/>
  <style>
    body { background:#111a22; color:#e7edf3; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .wrap { max-width:1040px; margin:24px auto; padding:0 16px; }
    h1 { font-size:22px; margin:16px 0; display:flex; align-items:center; gap:12px; }
    .bar { background:#0f2532; border-radius:10px; padding:10px 14px; margin:12px 0 16px; color:#87a2b3; font-size:13px; }
    .row { display:flex; gap:8px; align-items:center; }
    button { background:#1985ff; color:white; border:0; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:600; }
    button.link { background:transparent; border:1px solid #2b4252; }
    table { width:100%; border-collapse:collapse; background:#0e1d27; border-radius:12px; overflow:hidden; }
    th, td { padding:12px 14px; border-bottom:1px solid #142e3c; font-size:14px; }
    th { text-align:left; color:#9fb6c6; background:#0f2130; position:sticky; top:0; }
    tr:hover td { background:#132636; }
    .right { text-align:right; }
    #err { color:#ffb4b4; margin-top:8px; }
  </style>
  <script>
    // Optional: hardcode these if you don't want to pass in the URL
    window.DEFAULT_SUPABASE_URL  = "";
    window.DEFAULT_SUPABASE_ANON = "";
  </script>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <h1>
        <button id="syncBtn">Sync now</button>
        <span>Inventory (Live from Shopify)</span>
      </h1>
      <button class="link" id="movementBtn">Movement report</button>
    </div>
    <div class="bar">How this updates: Live updates arrive via Shopify Flow → Netlify Function → Supabase. This page reads from Supabase. Click <b>Sync now</b> to force‑refresh.</div>
    <div id="err"></div>
    <table id="tbl">
      <thead>
        <tr>
          <th>Product</th>
          <th>SKU</th>
          <th>Barcode</th>
          <th class="right">Price</th>
          <th class="right">SV</th>
          <th class="right">RH1</th>
          <th class="right">Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2.45.4";
  const urlParams = new URLSearchParams(window.location.search);
  const SB_URL  = urlParams.get("sbUrl")  || window.DEFAULT_SUPABASE_URL || "";
  const SB_ANON = urlParams.get("sbAnon") || window.DEFAULT_SUPABASE_ANON || "";
  if (!SB_URL || !SB_ANON) {
    console.error("Missing sbUrl or sbAnon. Provide them via query string or set DEFAULT_SUPABASE_* in the page.");
    document.getElementById("err").textContent = "Missing Supabase credentials. Add sbUrl & sbAnon to the URL.";
  }
  const supabase = createClient(SB_URL, SB_ANON);

  // Expose supabase to other inline scripts on the page
  window.supabase = supabase;
</script>


  <script type="module">
    async function load() {
      const tbody = document.querySelector("#tbl tbody");
      tbody.innerHTML = "<tr><td colspan='7' style='color:#7ea2b8'>Loading…</td></tr>";
      const { data, error } = await window.supabase
        .from("products_for_ui")
        .select("*")
        .order("name", { ascending: true });
      if (error) {
        document.getElementById("err").textContent = "Load error: " + error.message;
        tbody.innerHTML = "";
        return;
      }
      tbody.innerHTML = "";
      if (!data || data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='7' style='color:#7ea2b8'>No products found. Check Supabase view <b>products_for_ui</b>.</td></tr>";
        return;
      }
      for (const r of data) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.name ?? ""}</td>
          <td>${r.sku ?? ""}</td>
          <td>${r.barcode ?? ""}</td>
          <td class="right">${Number(r.price ?? 0).toFixed(2)}</td>
          <td class="right">${r.sv ?? 0}</td>
          <td class="right">${r.rh1 ?? 0}</td>
          <td class="right">${(Number(r.sv ?? 0)+Number(r.rh1 ?? 0))}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    async function syncNow() {
      try {
        const resp = await fetch("/.netlify/functions/shopify-sync-now", { method:"POST" });
        if (!resp.ok) throw new Error(await resp.text());
        alert("Sync complete");
        load();
      } catch (e) {
        alert("Sync failed: " + e.message);
      }
    }

    document.getElementById("syncBtn").addEventListener("click", syncNow);
    document.getElementById("movementBtn").addEventListener("click", () => {
      const qs = window.location.search;
      window.location.href = "movement.html" + qs;
    });

    load();
  </script>
</body>
</html>
