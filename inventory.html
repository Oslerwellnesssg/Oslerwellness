<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory (Live from Shopify)</title>
  <link rel="preconnect" href="https://unpkg.com">
  <style>
    :root { color-scheme: dark; }
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;background:#0f172a;margin:0;color:#e5e7eb}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .row{display:flex;align-items:center;gap:12px}
    h1{margin:0;font-size:22px;font-weight:700}
    button,a.btn{background:#0ea5e9;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    a.btn{display:inline-block;text-decoration:none}
    .pill{background:#0b1220;border:1px solid #233; border-radius:10px;padding:10px 12px;margin:16px 0;font-size:13px;color:#9ca3af}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{text-align:left;padding:12px 14px;background:#111827}
    th{font-size:12px;color:#9ca3af;font-weight:600}
    tr td:first-child, tr th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tr td:last-child, tr th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .muted{color:#9ca3af}
    .right{margin-left:auto}
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <button id="syncBtn">Sync now</button>
      <h1>Inventory (Live from Shopify)</h1>
      <a id="mvBtn" class="btn right" href="#">Movement report</a>
    </div>

    <div class="pill">
      <strong>How this updates:</strong>
      Live updates arrive via Shopify Flow → Netlify Function → Supabase. This page reads from Supabase. Click <em>Sync now</em> to force-refresh.
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th>Product</th>
          <th>SKU</th>
          <th>Barcode</th>
          <th>Price</th>
          <th>SV</th>
          <th>RH1</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <p class="muted" id="footNote"></p>
  </div>

<script>
// --- Configuration ---
// Option A: put values in window.__SB (Plato usually injects token; you can do the same for Supabase)
const SB_URL  = window.__SB_URL  || "YOUR_SUPABASE_URL";
const SB_ANON = window.__SB_ANON || "YOUR_SUPABASE_ANON_KEY";

// Keep Plato token when navigating
function getTokenQS(){
  const u = new URL(window.location.href);
  const t = u.searchParams.get("token");
  return t ? ("?token=" + encodeURIComponent(t)) : "";
}
document.getElementById("mvBtn").href = "movement.html" + getTokenQS();

const supa = supabase.createClient(SB_URL, SB_ANON);

async function loadFromProductsForUI(){
  // preferred view if present
  return await supa.from("products_for_ui").select("*").order("name");
}
async function loadFromBaseTables(){
  // fallback if view doesn't exist
  // we do two calls and stitch client-side to avoid RPCs
  const { data: products, error: e1 } = await supa.from("products")
    .select("id,name,sku,barcode,sell_price").order("name");
  if(e1) throw e1;
  const { data: levels, error: e2 } = await supa.from("stock_levels")
    .select("product_id,location,on_hand");
  if(e2) throw e2;
  const map = {};
  products.forEach(p=>{ map[p.id]={
    name:p.name, sku:p.sku, barcode:p.barcode, sell_price:p.sell_price,
    sv:0, rh1:0
  }});
  levels.forEach(l=>{
    const row = map[l.product_id]; if(!row) return;
    if(l.location==="SV") row.sv = l.on_hand||0;
    if(l.location==="RH1") row.rh1 = l.on_hand||0;
  });
  const rows = Object.values(map).map(r=>({
    name:r.name, sku:r.sku, barcode:r.barcode, price:r.sell_price,
    sv:r.sv, rh1:r.rh1, total:(r.sv|0)+(r.rh1|0)
  }));
  return { data: rows, error: null, _fallback: true };
}

function render(rows){
  const tb = document.getElementById("tbody");
  tb.innerHTML = "";
  rows.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.name||""}</td>
      <td>${r.sku||""}</td>
      <td>${r.barcode||""}</td>
      <td>${(r.price!=null)? Number(r.price).toFixed(2) : ""}</td>
      <td>${r.sv ?? 0}</td>
      <td>${r.rh1 ?? 0}</td>
      <td>${r.total ?? ((r.sv|0)+(r.rh1|0))}</td>
    `;
    tb.appendChild(tr);
  });
}

async function refresh(){
  document.getElementById("tbody").innerHTML = "";
  document.getElementById("footNote").textContent = "Loading…";
  try{
    let { data, error } = await loadFromProductsForUI();
    if(error) throw error;
    if(!data || !data.length){
      // some installs used slightly different column names
      // normalize shape
      data = (data||[]).map(d=>({
        name: d.name, sku:d.sku, barcode:d.barcode, price:d.sell_price ?? d.price,
        sv: d.sv ?? d.on_hand_sv ?? 0,
        rh1: d.rh1 ?? d.on_hand_rh1 ?? 0,
        total: d.total ?? d.on_hand_total ?? 0
      }));
      render(data);
      document.getElementById("footNote").textContent = "Loaded from view products_for_ui.";
      if(!data.length) throw new Error("Empty view, falling back");
      return;
    }
    data = data.map(d=>({
      name: d.name, sku:d.sku, barcode:d.barcode, price:d.sell_price ?? d.price,
      sv: d.sv ?? d.on_hand_sv ?? 0,
      rh1: d.rh1 ?? d.on_hand_rh1 ?? 0,
      total: d.total ?? d.on_hand_total ?? ((d.sv|0)+(d.rh1|0))
    }));
    render(data);
    document.getElementById("footNote").textContent = "Loaded from view products_for_ui.";
  }catch(e){
    // fallback
    try{
      const { data, _fallback } = await loadFromBaseTables();
      render(data);
      document.getElementById("footNote").textContent = "Loaded from base tables (products + stock_levels).";
    }catch(e2){
      document.getElementById("footNote").textContent = "Failed to load: " + e2.message;
    }
  }
}

document.getElementById("syncBtn").addEventListener("click", async ()=>{
  try{
    // call Netlify function using relative path (works both standalone and inside Plato iFrame)
    const res = await fetch("/.netlify/functions/shopify-sync-now", { method:"POST" });
    if(!res.ok){ throw new Error("HTTP " + res.status); }
    const j = await res.json().catch(()=>({ok:true}));
    alert("Sync complete");
  }catch(err){
    alert("Sync failed: " + err.message);
  }finally{
    refresh();
  }
});

// initial load
refresh();
</script>
</body>
</html>
