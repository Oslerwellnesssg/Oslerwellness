<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Inventory (Live from Shopify)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <style>
    body{background:#2b3640;}
    .container{max-width: 1100px;}
    .muted{opacity:.8;font-size:.9rem}
    .tabs{display:flex;gap:.5rem;margin:1rem 0;}
    .tabs button{border:1px solid #3c4854;background:#34414d;color:#fff}
    .tabs button.active{background:#485868}
    table{font-size:.92rem}
    .pill{padding:.15rem .5rem;border-radius:999px;background:#394957;color:#cde;}
    .right{float:right}
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2.44.4/dist/umd/supabase.js"></script>
</head>
<body>
  <main class="container">
    <header>
      <h2>Inventory (Live from Shopify)</h2>
      <p class="muted">This page reads from <strong>Supabase</strong>. Shopify Flow pushes changes here; the table refreshes in real-time.<span class="right"><button id="syncBtn" class="secondary">Sync now</button></span></p>
      <div class="tabs">
        <button id="tabInventory" class="active">Inventory</button>
        <button id="tabMovements">Movement report</button>
      </div>
    </header>

    <section id="inventoryView">
      <table role="grid" id="invTable">
        <thead>
          <tr>
            <th>Product</th><th>SKU</th><th>Barcode</th><th>Price</th><th>SV</th><th>RH1</th><th>Total</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="movementsView" style="display:none">
      <h4>Raffles (RH1)</h4>
      <table role="grid" id="mvRh1">
        <thead>
          <tr><th>Date/Time</th><th>Patient ID</th><th>Product</th><th>Qty</th><th>Price</th><th>Status</th></tr>
        </thead><tbody></tbody>
      </table>
      <h4 style="margin-top:2rem">Star Vista (SV)</h4>
      <table role="grid" id="mvSv">
        <thead>
          <tr><th>Date/Time</th><th>Patient ID</th><th>Product</th><th>Qty</th><th>Price</th><th>Status</th></tr>
        </thead><tbody></tbody>
      </table>
    </section>
  </main>

<script>
// ---- Config: reuse existing globals if present ----
const SUPABASE_URL = window.SUPABASE_URL || "%SUPABASE_URL%";
const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || "%SUPABASE_ANON_KEY%";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ---- UI helpers ----
function fmt(n){ return (n ?? 0).toLocaleString(undefined,{minimumFractionDigits:0});}
function price(n){ return (n ?? 0).toLocaleString(undefined,{style:'currency', currency:'SGD'});}
function tstamp(s){ return new Date(s).toLocaleString();}

async function loadInventory(){
  const { data, error } = await sb.from('products_with_balances').select('*').order('name');
  if (error){ console.error(error); return; }
  const tb = document.querySelector('#invTable tbody');
  tb.innerHTML = '';
  for (const r of data){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.name}</td><td>${r.sku ?? ''}</td><td>${r.barcode ?? ''}</td>
                    <td>${Number(r.sell_price).toFixed(2)}</td>
                    <td>${fmt(r.on_hand_sv)}</td>
                    <td>${fmt(r.on_hand_rh1)}</td>
                    <td>${fmt(r.on_hand_total)}</td>`;
    tb.appendChild(tr);
  }
}

async function loadMovements(){
  // Use v_ow_movement_report if present; fallback to movements_with_products
  let data = null;
  let error = null;
  let res = await sb.from('v_ow_movement_report').select('*').limit(300).order('created_at', { ascending: false });
  if (res.error){
    // fallback
    res = await sb.from('movements_with_products').select('*').in('type',['dispense','preorder']).order('created_at', { ascending: false }).limit(300);
  }
  data = res.data || [];
  error = res.error;
  if (error){ console.error(error); return; }

  const rh1 = document.querySelector('#mvRh1 tbody');
  const sv = document.querySelector('#mvSv tbody');
  rh1.innerHTML = sv.innerHTML = '';

  for (const r of data){
    // normalize fields across both views
    const created_at = r.created_at;
    const patient_id = r.patient_id ?? '';
    const product = r.product_name ?? r.name ?? '';
    const qty = r.qty_out ?? r.quantity ?? 0;
    const unit = r.unit_price ?? r.price ?? null;
    const status = r.status ?? (r.type === 'preorder' ? 'PRE-ORDER' : 'DISPENSED');
    const loc = (r.from_loc || r.location || '').toUpperCase();

    const row = `<tr><td>${tstamp(created_at)}</td><td>${patient_id}</td>
                 <td>${product}</td><td>${fmt(qty)}</td><td>${unit!=null?price(unit):''}</td><td><span class="pill">${status}</span></td></tr>`;
    if (loc === 'RH1') rh1.insertAdjacentHTML('beforeend', row);
    else sv.insertAdjacentHTML('beforeend', row);
  }
}

// Tabs
const tabInv = document.getElementById('tabInventory');
const tabMv = document.getElementById('tabMovements');
const viewInv = document.getElementById('inventoryView');
const viewMv = document.getElementById('movementsView');
tabInv.onclick = () => { tabInv.classList.add('active'); tabMv.classList.remove('active'); viewInv.style.display='block'; viewMv.style.display='none';};
tabMv.onclick = () => { tabMv.classList.add('active'); tabInv.classList.remove('active'); viewInv.style.display='none'; viewMv.style.display='block'; loadMovements();};

// Sync button (safe no-op unless server enabled)
document.getElementById('syncBtn').onclick = async () => {
  try{
    const res = await fetch('/.netlify/functions/shopify-sync-now', { method:'POST' });
    const js = await res.json().catch(()=>({}));
    alert(js && js.skipped ? 'Sync request acknowledged (no-op, using Flow only).' : 'Sync completed.');
  }catch(e){ alert('Sync error (see console)'); console.error(e); }
};

// initial
loadInventory();

// Realtime refresh on stock_levels change (if Realtime enabled)
try {
  sb.channel('realtime:stock_levels')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'stock_levels' }, loadInventory)
    .subscribe();
} catch(e){ console.warn('Realtime not enabled', e); }
</script>
</body>
</html>
